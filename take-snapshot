#!/bin/bash

#****************************************************************************************************#
#                                            TAKE-SNAPSHOT                                           #
#****************************************************************************************************#

#----------------------------------------------------------------------------------------------------#
# IF THE USER HAS NO ROOT PERMISSIONS THE SCRIPT WILL EXIT                                           #
#----------------------------------------------------------------------------------------------------#

if (($EUID!=0))
then
  echo "You must be root to run this script" 2>&1
  exit 1
fi

#----------------------------------------------------------------------------------------------------#
# CONFIGURATION VARIABLES                                                                            #
#----------------------------------------------------------------------------------------------------#

date_name=$(date +%Y-%m-%d_%H-%M)
shcreate=compressandsendlastsnapshot.sh
config_file="/root/data/snapshots/config"
compressed_folder=/root/data/snapshots/compressed-snapshot/
filename="$compressed_folder$date_name.tar.gz"

#----------------------------------------------------------------------------------------------------#
# MAIN PART OF THE SCRIPT                                                                            #
#----------------------------------------------------------------------------------------------------#

if [ ! -d "$compressed_folder" ]
then
  mkdir -p "$compressed_folder"
fi
snapname=$(curl http://127.0.0.1:8888/v1/producer/create_snapshot | jq '.snapshot_name')
cd $compressed_folder
rm -f $shcreate
touch $shcreate && chmod +x $shcreate
ls -F *.gz | head -n -5 | xargs -r rm
echo "tar -cvzf $filename $snapname" >> $shcreate
